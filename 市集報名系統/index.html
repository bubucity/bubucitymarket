<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¸‚é›†å ±åç³»çµ±</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;700&family=Zen+Maru+Gothic:wght@500&family=DotGothic16&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #FDFBF7; --card: rgba(255, 255, 255, 0.95); --primary: #A08D7D; --accent: #8B5E3C; --text: #444; --border: #DECeb5; --font-family: 'Noto Serif TC', serif; --radius: 12px; --shadow: 0 10px 25px rgba(0, 0, 0, 0.08); --border-width: 1px; --success: #28a745; --danger: #dc3545; --warning: #ffc107; --info: #17a2b8; }
    body { font-family: var(--font-family); color: var(--text); background-color: var(--bg); padding: 0; margin: 0; line-height: 1.6; min-height: 100vh; position: relative; padding-bottom: 60px; transition: color 0.3s, background-color 0.3s; }
    body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: var(--bg-img); background-size: cover; background-position: center; background-repeat: no-repeat; filter: blur(8px) brightness(1.05); transform: scale(1.05); transition: background-image 0.5s ease; }
    .container { max-width: 900px; margin: 40px auto; background: var(--card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow); border: var(--border-width) solid rgba(255,255,255,0.6); backdrop-filter: blur(10px); }
    h2, h3, h4 { text-align: center; color: var(--accent); margin-bottom: 25px; font-weight: bold; }
    .brand-header { text-align: center; margin-bottom: 25px; } .brand-logo { max-height: 120px; max-width: 100%; margin-bottom: 15px; display: none; }
    .btn { padding: 12px 24px; background: var(--accent); color: white; border: none; border-radius: var(--radius); cursor: pointer; transition:0.2s; font-size:16px; font-family: var(--font-family); font-weight: bold; letter-spacing: 1px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .btn-sm { padding: 5px 12px; font-size: 13px; border-radius: 6px; border:none; cursor:pointer; color:white; background:#888; transition:0.2s;} .btn-sm:hover { opacity: 0.9; } .btn-blue { background: #007bff; } .btn-green { background: #28a745; } .btn-red { background: #dc3545; }
    input, select, textarea { padding: 12px; border: var(--border-width) solid #ccc; border-radius: var(--radius); width: 100%; box-sizing: border-box; font-family: inherit; background: rgba(255,255,255,0.9); margin-bottom: 10px; }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; background: #fff; box-shadow: 0 0 0 3px rgba(139, 94, 60, 0.1); }
    .powered-by { position: fixed; bottom: 10px; left: 0; width: 100%; text-align: center; font-size: 12px; color: rgba(0, 0, 0, 0.5); text-shadow: 0 1px 0 rgba(255, 255, 255, 0.8); z-index: 9999; pointer-events: none; font-family: sans-serif; letter-spacing: 1px; }
    #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #successModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
    .modal-content { background: white; padding: 40px; border-radius: 16px; max-width: 450px; text-align: center; border-top: 8px solid var(--accent); box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
    .line-id-box { background: #f0f9f0; padding: 15px; font-size: 1.4em; font-weight: bold; color: #00B900; margin: 20px 0; border-radius: 8px; border: 2px dashed #00B900; }
    .group-container { border: 1px solid #eee; border-radius: var(--radius); margin-bottom: 25px; overflow: hidden; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.03); transition:0.2s; }
    .group-container:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
    .group-header { padding: 18px 25px; background: #fafafa; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; }
    .group-title { font-weight: bold; font-size: 1.2em; color: var(--text); margin-bottom: 5px; }
    .group-date-range { font-size: 0.95em; color: #666; display: flex; align-items: center; gap: 8px; }
    .group-desc-content { padding: 20px 25px; background: #fffcf5; color: #555; font-size: 0.95em; white-space: pre-wrap; border-bottom: 1px dashed #eee; display: none; line-height: 1.8; }
    .group-dates-area { padding: 20px 25px; }
    .desc-toggle-btn { background: none; border: 1px solid #ccc; padding: 4px 10px; border-radius: 20px; cursor: pointer; font-size: 0.85em; color: #666; transition: 0.2s; }
    .desc-toggle-btn:hover { background: #eee; color: #333; }
    .date-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
    .date-card { border: var(--border-width) solid #e0e0e0; padding: 15px 10px; text-align: center; border-radius: var(--radius); cursor: pointer; background: #fff; position: relative; transition:0.2s; }
    .date-card:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .date-card.selected { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 5px 15px rgba(139, 94, 60, 0.3); }
    .date-card.disabled { background: #f5f5f5; color: #bbb; pointer-events: none; border-color:#eee; }
    .tag-full { position: absolute; top: -8px; right: -5px; background: #c0392b; color: white; font-size: 10px; padding: 2px 8px; border-radius: 12px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .event-desc-box { background: #eef7ff; border-left: 4px solid #2196F3; padding: 15px; margin-top: 20px; border-radius: var(--radius); white-space: pre-wrap; font-size: 0.95em; color: #333; display: none; }
    .batch-card { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 20px; margin-bottom: 15px; border-left: 5px solid var(--accent); box-shadow: 0 2px 10px rgba(0,0,0,0.03); transition:0.2s; }
    .batch-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
    .batch-header { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; color: #333; }
    .batch-dates { font-size: 0.9em; color: #666; margin-bottom: 10px; }
    .batch-subtotal { text-align: right; font-weight: bold; color: var(--accent); margin-top: 10px; padding-top: 5px; border-top: 1px dashed #ccc; }
    .terms-box { background: #fdfdfd; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-top: 20px; font-size: 0.9em; color: #444; max-height: 300px; overflow-y: auto; }
    .terms-footer { margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; font-weight: bold; color: var(--accent); }
    /* å¾Œå° */
    .schedule-container { display: flex; flex-direction: column; gap: 30px; }
    .schedule-day { border: 1px solid #ddd; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); background: #fff; }
    .schedule-header { background: var(--primary); color: white; padding: 15px 25px; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
    .schedule-body { padding: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; background: #fff; }
    .stall-group { background: #fdfdfd; border: 1px solid #eee; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .stall-title { font-size: 1em; color: var(--accent); font-weight: bold; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; }
    .stall-item { font-size: 0.9em; padding: 10px; border: 1px solid #f0f0f0; background: #fff; margin-bottom: 8px; border-radius: 6px; transition: 0.2s; }
    .stall-item:hover { border-color: #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .stall-item.overbooked { background: #fff0f0; border-color: #ffcccc; }
    .item-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; color:#333; }
    .item-badges { display: flex; gap: 5px; }
    .styled-table { width: 100%; border-collapse: collapse; font-size: 0.95em; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); white-space: nowrap; }
    .styled-table thead tr { background-color: var(--primary); color: #ffffff; text-align: left; }
    .styled-table th, .styled-table td { padding: 15px 20px; border-bottom: 1px solid #eee; }
    .styled-table tbody tr:nth-of-type(even) { background-color: #fcfcfc; }
    .styled-table tbody tr:hover { background-color: #f0f7ff; }
    .border-color-0 { border-left: 5px solid #A9CCE3; } .border-color-1 { border-left: 5px solid #A3E4D7; } .border-color-2 { border-left: 5px solid #F9E79F; } .border-color-3 { border-left: 5px solid #F5B7B1; } .border-color-4 { border-left: 5px solid #D7BDE2; } .border-color-5 { border-left: 5px solid #EDBB99; }
    .hidden { display: none !important; }
    .admin-nav { display:flex; gap:10px; margin-bottom:30px; border-bottom:2px solid #eee; padding-bottom:15px; flex-wrap: wrap;}
    .admin-nav button { background:white; color:var(--text); border:1px solid #ddd; padding: 10px 20px; }
    .admin-nav button.active { background:var(--accent); color:white; border-color:var(--accent); transform: translateY(2px); }
    .read-only-mode button[onclick*="delete"], .read-only-mode button[onclick*="remove"], .read-only-mode button[onclick*="delReg"], .read-only-mode button[onclick*="save"], .read-only-mode button[onclick*="addStall"], .read-only-mode button[onclick*="toggle"] { display: none !important; }
    .read-only-mode input, .read-only-mode textarea, .read-only-mode select { pointer-events: none; background-color: #eee; color: #555; border-color: #ccc; }
    .read-only-mode .admin-nav button, .read-only-mode button[onclick*="editDate"], .read-only-mode button[onclick*="download"] { display: inline-block !important; pointer-events: auto !important; }
    #guestNotice { background: #e7f3fe; color: #0c5460; padding: 15px; text-align: center; margin-bottom: 25px; border-radius: 8px; display: none; border: 1px solid #bee5eb; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .finance-card { background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.2s; }
    .finance-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .finance-header { font-size: 1.2em; font-weight: bold; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .finance-row { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 12px; font-size: 1.05em; }
    .finance-total { font-weight: bold; font-size: 1.2em; color: var(--success); text-align: right; margin-top: 20px; padding-top: 15px; border-top: 2px solid #eee; }
    .grand-total-box { background: #2c3e50; color: white; padding: 30px; border-radius: 12px; text-align: center; font-size: 1.8em; margin-bottom: 40px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
  <div class="powered-by">System Designed by æ–‡æ­¦èŒ¶å¿ƒ</div>
  <div id="loading"><div class="spinner"></div><div style="margin-top:10px;">ç³»çµ±è™•ç†ä¸­...</div><div id="errorMsg" style="color:red; margin-top:20px; font-size:0.8em; max-width:80%; text-align:center;"></div></div>
  <div id="successModal"><div class="modal-content"><h2 style="margin:0 0 10px 0;">ğŸ‰ å ±åæˆåŠŸï¼</h2><p>è«‹å‹™å¿…å®Œæˆä»¥ä¸‹æ­¥é©Ÿä»¥åˆ©å¯©æ ¸ï¼š</p><div style="text-align:left; margin:15px 0; font-size:0.95em; color:#555;">1. åŠ å…¥å®˜æ–¹ Line å¸³è™Ÿ<br>2. <b>ä¸»å‹•å‚³é€è¨Šæ¯</b>å‘ŠçŸ¥æ‚¨çš„ã€Œå“ç‰Œåç¨±ã€</div><div class="line-id-box">ID: @850idwyv</div><p style="color:#888; font-size:0.85em; margin-top:15px;">(å ±åå®Œæˆå¾Œé é¢å°‡æœƒé‡ç½®ï¼Œå¦‚éœ€å†æ¬¡å ±åè«‹é‡æ–°æ•´ç†)</p><button class="btn" style="width:100%;" onclick="location.reload()">æˆ‘çŸ¥é“äº†ï¼Œå®Œæˆå ±å</button></div></div>
  
  <div class="container" id="appView">
    <div class="brand-header"><img id="appLogo" class="brand-logo" alt="Logo"><h2 id="appTitle">å¸‚é›†å ±åç³»çµ±</h2></div>
    <div style="background:#fff4e6; color:#d35400; padding:15px; border-radius:var(--radius); font-size:0.95em; margin-bottom:30px; border:1px solid #ffe0b2; box-shadow: 0 2px 5px rgba(0,0,0,0.05);"><b>âš ï¸ é‡è¦æé†’ï¼š</b>å ±åå¾Œè«‹å‹™å¿…åŠ å…¥å®˜æ–¹ Line <b>@850idwyv</b> ä¸¦ä¸»å‹•å‘ŠçŸ¥å“ç‰Œåç¨±ã€‚</div>
    <form id="regForm"><label>å“ç‰Œåç¨±</label><input type="text" name="brandName" required placeholder="è¡ŒéŠ·æ›å…‰ä½¿ç”¨"><label>å“ç‰Œç†å¿µ</label><textarea name="concept" rows="2"></textarea><label>ä¸»è¦å•†å“</label><input type="text" name="mainProduct" required><label>å“ç‰Œ/å•†å“ç…§ç‰‡ (æœ€å¤š5å¼µ)</label><input type="file" id="fileInput" multiple accept="image/*" required><div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;"><div><label>è¯çµ¡äºº</label><input type="text" name="contactName" required></div><div><label>é›»è©±</label><input type="tel" name="contactPhone" required></div></div><label>Line ID</label><input type="text" name="lineId" required><label>ç¤¾ç¾¤é€£çµ</label><input type="text" name="socialLink" placeholder="IG/FB/å®˜ç¶²"><hr style="margin:30px 0; border:0; border-top:1px dashed #ccc;"><label>é¸æ“‡æª”æœŸ (é»é–‹è©³æƒ…å¯çœ‹æ´»å‹•èªªæ˜)</label><div id="groupsContainer"></div><div id="eventDescDisplay" class="event-desc-box"></div><h3 style="margin-top:40px; border-bottom:2px solid var(--border); padding-bottom:15px;">æª”æœŸæ”¤ä½é¸æ“‡èˆ‡è²»ç”¨</h3><div id="batchConfigArea"><div style="color:#888; font-style:italic; padding:15px; background:#f9f9f9; border-radius:8px; text-align:center;">è«‹å…ˆé¸æ“‡ä¸Šæ–¹æ—¥æœŸï¼Œæ­¤è™•å°‡é¡¯ç¤ºå°æ‡‰çš„æ”¤ä½é¸é …ã€‚</div></div><div style="background:#f9f9f9; padding:20px; margin-top:25px; border-radius:var(--radius); border:1px solid #eee;"><div style="font-weight:bold; font-size:1.4em; text-align:right; color:var(--text);">ç¸½é‡‘é¡ï¼š<span id="txtTotal">NT$ 0</span></div></div><div class="terms-box"><h4>ğŸ“œ å ±åè¦ç¯„èˆ‡è²æ˜</h4><ul><li><b>ç¡¬é«”è¦ç¯„ï¼š</b>ç¾å ´åƒ…æä¾› 110V å¼±é›»ï¼Œè«‹è‡ªå‚™ç…§æ˜è¨­å‚™ã€‚å¯ä½¿ç”¨æ˜ç«ï¼ˆéœ€å‚™å¦¥å®‰å…¨é˜²è­·ï¼‰ã€‚é›¢å ´å‰å‹™å¿…è¾¦ç†ç°½é€€ä»¥é ˜å›æŠ¼é‡‘ã€‚</li><li><b>ç‡Ÿé‹æ¬Šè²¬ï¼š</b>ä¸»è¾¦å–®ä½ä¿æœ‰ä¾å¯¦éš›ç‹€æ³èª¿æ•´æ´»å‹•å…§å®¹ã€æ™‚é–“åŠå ´åœ°é…ç½®ä¹‹æœ€çµ‚æ¬Šåˆ©ã€‚</li><li><b>äº¤æ˜“è²¬ä»»ï¼š</b>å“ç‰Œèˆ‡é¡§å®¢é–“ä¹‹äº¤æ˜“è¡Œç‚ºå±¬è²·è³£é›™æ–¹æ¬Šè²¬ï¼Œèˆ‡ä¸»è¾¦å–®ä½ç„¡æ¶‰ï¼Œç›¸é—œæ¶ˆè²»çˆ­è­°éœ€è‡ªè¡Œè™•ç†ã€‚</li><li><b>é€²å ´è¦ç¯„ï¼š</b>è«‹å‹™å¿…é…åˆä¸»è¾¦å–®ä½å®‰æ’ä¹‹æŒ‡å®šæ™‚é–“èˆ‡å‹•ç·šé€²å ´å¸è²¨åŠé™³åˆ—ã€‚</li><li><b>è¯ç¹«ç¾©å‹™ï¼š</b>å ±åå¾Œè«‹<b>ç«‹å³</b>åŠ å…¥å®˜æ–¹ LINE å¸³è™Ÿä¸¦ä¸»å‹•å‚³é€å“ç‰Œåç¨±ã€‚å› ç³»çµ±é™åˆ¶ï¼Œéœ€ç”±æ‚¨ä¸»å‹•é–‹å•Ÿå°è©±ï¼Œæ–¹èƒ½æ¥æ”¶å¾ŒçºŒé€šçŸ¥ã€‚</li><li><b>ç¹³è²»æœŸé™ï¼š</b>æ”¶åˆ°éŒ„å–é€šçŸ¥å¾Œï¼Œè«‹æ–¼ <b>2 æ—¥å…§</b>å®Œæˆç§Ÿé‡‘èˆ‡æŠ¼é‡‘åŒ¯æ¬¾ã€‚è‹¥æœªä¸»å‹•è¯ç¹«æˆ–é€¾æœŸæœªç¹³ï¼Œå°‡è¦–ç‚ºæ”¾æ£„ä¸¦å½±éŸ¿æœªä¾†å ±åæ¬Šç›Šã€‚</li></ul><div class="terms-footer"><input type="checkbox" id="agree" required><label for="agree" style="cursor:pointer; margin-left:5px;">æˆ‘å·²è©³é–±ä¸¦åŒæ„ä¸Šè¿°æ‰€æœ‰è¦ç¯„</label></div></div><button type="button" class="btn" onclick="submitData()" style="width:100%; margin-top:30px; padding:15px; font-size:1.1em;">é€å‡ºå ±å</button></form></div>
  
  <div class="container hidden" id="adminView" style="max-width:1100px; border-top:5px solid var(--accent);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;"><h3>å¾Œå°ç®¡ç†ä¸­å¿ƒ</h3><button onclick="location.reload()" class="btn-sm">ç™»å‡º</button></div>
      <div id="guestNotice">ğŸ” å¾Œå°æŸ¥è©¢æ¨¡å¼ (åƒ…ä¾›ç€è¦½)</div>
      <div class="admin-nav"><button onclick="switchTab('schedule')" id="btn-schedule" class="btn active">ğŸ“… æ’ç¨‹ç¸½è¡¨</button><button onclick="switchTab('list')" id="btn-list" class="btn">ğŸ“‹ å ±ååˆ—è¡¨</button><button onclick="switchTab('finance')" id="btn-finance" class="btn">ğŸ’° è²¡å‹™å ±è¡¨</button><button onclick="switchTab('blacklist')" id="btn-blacklist" class="btn" style="border-color:#dc3545; color:#dc3545;">ğŸš« é•è¦åå–®</button><button onclick="switchTab('settings')" id="btn-settings" class="btn">âš™ï¸ æª”æœŸè¨­å®š</button></div>
      <div id="tab-schedule"><div style="margin-bottom:15px; color:#666; font-size:0.9em; background:#fff3cd; padding:10px; border-radius:5px;">* ç´…è‰²èƒŒæ™¯ä»£è¡¨æ’æœŸ/è¶…è³£ (é•è¦åå–®ä¸ä½”åé¡)</div><div id="scheduleContainer" class="schedule-container"></div></div>
      <div id="tab-list" class="hidden"><div style="text-align:right; margin-bottom:15px;"><button class="btn btn-green" onclick="downloadExcel()">ğŸ“¥ åŒ¯å‡º Excel (åˆ†æª”æœŸ)</button></div><div style="overflow-x:auto; padding-bottom:10px;"><table class="styled-table"><thead><tr><th>å ±åæ™‚é–“</th><th>å“ç‰Œ</th><th>å ±åæª”æœŸæ‘˜è¦</th><th>ç¸½è²»ç”¨</th><th>ç…§ç‰‡</th><th>ç¹³æ¬¾</th><th>å¯©æ ¸</th><th>æ“ä½œ</th></tr></thead><tbody id="regTableBody"></tbody></table></div></div>
      <div id="tab-finance" class="hidden"><div id="financeContainer"></div></div>
      <div id="tab-blacklist" class="hidden"><div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #dc3545; padding-bottom:10px; margin-bottom:15px;"><h4 style="margin:0; color:#dc3545;">ğŸš« é•åè¦å®šåå–®</h4><button class="btn btn-red" onclick="downloadBlacklist()">ğŸ“¥ åŒ¯å‡ºé•è¦åå–®</button></div><div style="overflow-x:auto; padding-bottom:10px;"><table class="styled-table"><thead><tr><th>å ±åæ™‚é–“</th><th>å“ç‰Œåç¨±</th><th>è¯çµ¡äºº</th><th>é›»è©± / Line</th><th>é•è¦æª”æœŸ</th><th>é•è¦åŸå›  (å‚™è¨»)</th></tr></thead><tbody id="blacklistBody"></tbody></table></div></div>
      <div id="tab-settings" class="hidden">
          <div id="appearanceSettings" style="border:1px solid #ddd; padding:25px; border-radius:8px; background:#f0f7ff; margin-bottom:30px; border-left:5px solid var(--info);"><h4 style="margin-top:0;">ğŸ¨ ç³»çµ±å¤–è§€è¨­å®š</h4><div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;"><div><label>é¸æ“‡é¢¨æ ¼ä¸»é¡Œ</label><select id="themeSelect" onchange="changeTheme(this.value)"><option value="æ¨™æº–">æ¨™æº– (Standard)</option><option value="æ–‡é’ç°¡ç´„">æ–‡é’ç°¡ç´„ (Simple)</option><option value="æ´»æ½‘å¯æ„›">æ´»æ½‘å¯æ„› (Cute)</option><option value="ç©©é‡æ‡·èˆŠ">ç©©é‡æ‡·èˆŠ (Retro)</option><option value="å„ªé›…å¤§æ°£">å„ªé›…å¤§æ°£ (Elegant)</option><option value="è¡—é ­é¢¨æ ¼">è¡—é ­é¢¨æ ¼ (Street)</option><option value="æº«æŸ”å©‰ç´„">æº«æŸ”å©‰ç´„ (Gentle)</option></select></div><div><small style="color:#666; line-height:1.6;">å¦‚éœ€æ›´æ”¹ <b>æ¨™é¡Œ</b> æˆ– <b>Logo</b>ï¼Œ<br>è«‹è‡³ Google è©¦ç®—è¡¨ä¿®æ”¹ã€‚</small></div></div></div>
          <div id="passwordManager" style="border:1px solid #ddd; padding:25px; border-radius:8px; background:#fff8e1; margin-bottom:30px;"><h4 style="margin-top:0;">ğŸ”’ ç³»çµ±å¯†ç¢¼ç®¡ç†</h4><div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;"><div><label>ç®¡ç†å“¡å¯†ç¢¼</label><div style="display:flex; gap:10px;"><input type="text" id="adminPassInput" placeholder="é è¨­8888"><button class="btn-sm" onclick="changePass('admin')">ä¿®æ”¹</button></div></div><div><label>è¨ªå®¢å¯†ç¢¼</label><div style="display:flex; gap:10px;"><input type="text" id="guestPassInput" placeholder="é è¨­0000"><button class="btn-sm" onclick="changePass('guest')">ä¿®æ”¹</button></div></div></div></div>
          <div style="border:1px solid #ddd; padding:25px; border-radius:8px; background:#e8f4fd; margin-bottom:30px;"><h4 style="margin-top:0;">ğŸ“ æª”æœŸæ´»å‹•è©³ç´°æ•˜è¿° (å…¨åŸŸ)</h4><textarea id="globalDescInput" rows="5" maxlength="3000" placeholder="è«‹è¼¸å…¥æ´»å‹•è©³ç´°èªªæ˜..." oninput="updateCharCount(this)"></textarea><div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;"><small style="color:#666;">å­—æ•¸ï¼š<span id="charCount">0</span> / 3000</small><button class="btn btn-blue" onclick="saveGlobalDescription()">æ›´æ–°èªªæ˜</button></div></div>
          <div style="border:1px solid #ddd; padding:25px; border-radius:8px; background:#fdfdfd;"><h4 id="settingFormTitle">æ–°å¢/ç·¨è¼¯æª”æœŸå€å¡Š (Batch)</h4><div style="background:#f9f9f9; padding:15px; border-radius:5px; border:1px solid #eee; margin-bottom:20px;"><label>æª”æœŸå€é–“</label><div style="display:flex; gap:10px; align-items:center;"><input type="date" id="newStartDate"> è‡³ <input type="date" id="newEndDate"></div></div><div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-bottom:15px;"><div><label>ä¸»é¡Œåç¨±</label><input type="text" id="newThemeVal" placeholder="ä¾‹å¦‚ï¼šå¤æ—¥ç¥­å…¸"></div><div><label>æŠ¼é‡‘ (æ•´æª”)</label><input type="number" id="newDepositVal" value="1000"></div></div><label>æª”æœŸæ´»å‹•è©³ç´°èªªæ˜ (å¯ç•™ç©º)</label><textarea id="newGroupDesc" rows="4" placeholder="è«‹è¼¸å…¥æœ¬æª”æœŸçš„è©³ç´°æ‹›å•†è³‡è¨Š..." style="margin-bottom:15px;"></textarea><div style="display:flex; gap:20px; margin-bottom:15px;"><div><label>é–‹å§‹æ™‚é–“</label><input type="time" id="newStartTime"></div><div><label>çµæŸæ™‚é–“</label><input type="time" id="newEndTime"></div></div><label>æ”¤ä½é¡å‹èˆ‡åé¡</label><div id="newStallContainer"></div><button class="btn-sm" onclick="addStallInputRow()" style="margin-top:10px;">+ å¢åŠ æ”¤ä½é¡å‹</button><hr style="margin:20px 0;"><button class="btn" id="saveDateBtn" onclick="saveDateConfig()">å»ºç«‹/æ›´æ–°æª”æœŸå€å¡Š</button><button class="btn-sm" id="cancelEditBtn" onclick="resetSettingForm()" style="background:#999; display:none; margin-left:10px;">å–æ¶ˆç·¨è¼¯</button></div>
          <h4 style="margin-top:40px;">ç¾æœ‰æª”æœŸåˆ—è¡¨</h4><div id="adminDateList"></div>
      </div>
  </div>
  <div onclick="adminLoginPrompt()" style="position:fixed; bottom:5px; right:5px; opacity:0.1; cursor:pointer;">Admin</div>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxbIYMNXxNr672zQ0BvAYBy1UQwjtRRkOBfHxYOZPPo5V3hAcK79Lr94yyZYeB7eftr/exec"; 
    let appData = { settings: { dates: [] }, registrations: [] };
    let selectedDates = []; let editingGroupId = null; let userStallChoices = {}; let isReadOnly = false; 
    const THEMES = { 'æ¨™æº–': { '--bg': '#FDFBF7', '--primary': '#A08D7D', '--accent': '#8B5E3C', '--text': '#444', '--radius': '12px', '--font-family': '"Noto Serif TC", serif', '--border-width': '1px' }, 'æ–‡é’ç°¡ç´„': { '--bg': '#F5F5F5', '--primary': '#607D8B', '--accent': '#455A64', '--text': '#333333', '--radius': '2px', '--font-family': '"Noto Sans TC", sans-serif', '--border-width': '1px' }, 'æ´»æ½‘å¯æ„›': { '--bg': '#FFF5F7', '--primary': '#FFB7C5', '--accent': '#FF69B4', '--text': '#5D4037', '--radius': '20px', '--font-family': '"Zen Maru Gothic", sans-serif', '--border-width': '2px' }, 'ç©©é‡æ‡·èˆŠ': { '--bg': '#F4ECD8', '--primary': '#8B4513', '--accent': '#800000', '--text': '#3E2723', '--radius': '4px', '--font-family': '"Noto Serif TC", serif', '--border-width': '1px' }, 'å„ªé›…å¤§æ°£': { '--bg': '#0F172A', '--card': 'rgba(255,255,255,0.95)', '--primary': '#D4AF37', '--accent': '#B8860B', '--text': '#1E293B', '--radius': '6px', '--font-family': '"Noto Serif TC", serif', '--border-width': '1px' }, 'è¡—é ­é¢¨æ ¼': { '--bg': '#111', '--card': '#fff', '--primary': '#000', '--accent': '#39FF14', '--text': '#000', '--radius': '0px', '--border-width': '3px', '--font-family': '"Noto Sans TC", sans-serif' }, 'æº«æŸ”å©‰ç´„': { '--bg': '#F3F0FF', '--primary': '#B0C4DE', '--accent': '#9370DB', '--text': '#4A4E69', '--radius': '12px', '--font-family': '"Zen Maru Gothic", sans-serif', '--border-width': '1px' } };
    window.onload = function() { fetchData('getInitialData'); };
    function fetchData(action, params = {}) { document.getElementById('loading').style.display = 'flex'; let url = `${API_URL}?action=${action}`; if(action === 'verifyLogin') url += `&pass=${params}`; let options = {}; if (['submit', 'updateStatus', 'saveConfig', 'saveSystemSetting', 'updatePassword'].includes(action)) { options = { method: 'POST', body: JSON.stringify({ action: action, ...params }) }; } fetch(url, options).then(res => res.json()).then(data => { document.getElementById('loading').style.display = 'none'; if(action === 'getInitialData') initApp(data); else if(action === 'verifyLogin') handleLogin(data); else if(action === 'submit') { if(data.success) document.getElementById('successModal').style.display = 'flex'; else alert('éŒ¯èª¤: ' + data.error); } else if(action === 'updateStatus') { } else if(action === 'saveConfig' || action === 'updatePassword') { alert('å„²å­˜æˆåŠŸ'); if(action === 'saveConfig') { resetSettingForm(); renderSettingsList(); } } else if(action === 'saveSystemSetting') { alert('é¢¨æ ¼å·²æ›´æ–°ï¼'); location.reload(); } }).catch(err => { document.getElementById('loading').style.display = 'none'; document.getElementById('errorMsg').innerText = "é€£ç·šéŒ¯èª¤ï¼š" + err; }); }
    function initApp(data) { appData = data; if(appData.settings.systemTitle) { document.title = appData.settings.systemTitle; document.getElementById('appTitle').innerText = appData.settings.systemTitle; } if(appData.settings.systemLogo) { const logoImg = document.getElementById('appLogo'); logoImg.src = appData.settings.systemLogo; logoImg.style.display = 'inline-block'; } if(appData.settings.systemBackground) { document.body.style.setProperty('--bg-img', `url('${appData.settings.systemBackground}')`); } if(appData.settings.systemTheme && THEMES[appData.settings.systemTheme]) { applyTheme(appData.settings.systemTheme); document.getElementById('themeSelect').value = appData.settings.systemTheme; } renderFrontGroups(); if(appData.settings.globalDescription) { document.getElementById('eventDescDisplay').innerText = appData.settings.globalDescription; document.getElementById('eventDescDisplay').style.display = 'block'; document.getElementById('globalDescInput').value = appData.settings.globalDescription; updateCharCount(document.getElementById('globalDescInput')); } addStallInputRow("å¸³ç¯·æ”¤ä½ (3x3m)", 800, 1500, 6); addStallInputRow("ç„¡å‚˜æ¡Œæ”¤ä½", 600, 1000, 11); addStallInputRow("é¤è»Šæ”¤ä½", 1000, 1800, 5); }
    function changeTheme(themeName) { applyTheme(themeName); fetchData('saveSystemSetting', { key: 'SystemTheme', value: themeName }); }
    function applyTheme(themeName) { const theme = THEMES[themeName]; if(!theme) return; for (const [key, value] of Object.entries(theme)) { document.documentElement.style.setProperty(key, value); } }
    function renderFrontGroups() { const container = document.getElementById('groupsContainer'); container.innerHTML = ''; const groups = {}; appData.settings.dates.forEach(d => { if (d.open === false) return; const gid = d.groupId || ('LEGACY-' + d.date); if (!groups[gid]) groups[gid] = []; groups[gid].push(d); }); const sortedGids = Object.keys(groups).sort((a,b) => new Date(groups[a][0].date) - new Date(groups[b][0].date)); sortedGids.forEach((gid, index) => { const groupDates = groups[gid].sort((a,b) => new Date(a.date) - new Date(b.date)); const first = groupDates[0]; const last = groupDates[groupDates.length-1]; const rangeStr = (groupDates.length > 1) ? `${formatDateShort(first.date)} ~ ${formatDateShort(last.date)}` : formatDateShort(first.date); const colorIndex = index % 6; const card = document.createElement('div'); card.className = `group-container border-color-${colorIndex}`; const hasDesc = first.description && first.description.trim().length > 0; const descHtml = hasDesc ? `<div class="group-desc-content" id="desc-${gid}">${first.description}</div>` : ''; const btnHtml = hasDesc ? `<button type="button" class="desc-toggle-btn" onclick="toggleDesc('desc-${gid}', this)">ğŸ“„ æŸ¥çœ‹æ´»å‹•è©³æƒ… â–¼</button>` : `<span style="font-size:0.8em; color:#999;">ç„¡è©³ç´°èªªæ˜</span>`; card.innerHTML = `<div class="group-header"><div><div class="group-title">${first.theme}</div><div class="group-date-range">ğŸ“… ${rangeStr} <small>(${first.start}~${first.end})</small></div></div>${btnHtml}</div>${descHtml}<div class="group-dates-area"><div class="date-grid" id="grid-${gid}"></div></div>`; container.appendChild(card); const grid = card.querySelector(`#grid-${gid}`); groupDates.forEach(d => { const dateObj = new Date(d.date); const dayName = dateObj.toLocaleDateString('zh-TW', {weekday:'short'}); const dateNum = d.date.split('-')[2]; const btn = document.createElement('div'); btn.className = `date-card ${d.full ? 'disabled' : ''}`; btn.innerHTML = `<div style="font-weight:bold; font-size:1.1em;">${dateNum} <small>(${dayName})</small></div>${d.full ? '<span class="tag-full">é¡æ»¿</span>' : ''}`; if (!d.full) { btn.onclick = () => { const idx = selectedDates.indexOf(d.date); if(idx > -1) { selectedDates.splice(idx, 1); btn.classList.remove('selected'); } else { selectedDates.push(d.date); btn.classList.add('selected'); } renderBatchConfigurators(); }; } grid.appendChild(btn); }); }); }
    function renderBatchConfigurators() { const container = document.getElementById('batchConfigArea'); container.innerHTML = ''; if (selectedDates.length === 0) { container.innerHTML = '<div style="color:#888; font-style:italic; padding:15px; background:#f9f9f9; border-radius:8px; text-align:center;">è«‹å…ˆé¸æ“‡ä¸Šæ–¹æ—¥æœŸï¼Œæ­¤è™•å°‡é¡¯ç¤ºå°æ‡‰çš„æ”¤ä½é¸é …ã€‚</div>'; calculateTotal(); return; } const groups = {}; selectedDates.forEach(dateStr => { const config = appData.settings.dates.find(d => d.date === dateStr); if(config) { const gid = config.groupId || dateStr; if(!groups[gid]) groups[gid] = []; groups[gid].push(dateStr); } }); Object.entries(groups).forEach(([gid, dates]) => { const firstDate = dates[0]; const config = appData.settings.dates.find(d => d.date === firstDate); if(!config) return; const card = document.createElement('div'); card.className = 'batch-card'; const currentChoice = userStallChoices[gid] || ""; let optionsHtml = '<option value="" disabled selected>è«‹é¸æ“‡æ”¤ä½é¡å‹</option>'; config.stalls.forEach(s => { const selected = s.name === currentChoice ? 'selected' : ''; optionsHtml += `<option value="${s.name}" ${selected}>${s.name} (å–®$${s.price1}/é›™$${s.price2})</option>`; }); card.innerHTML = `<div class="batch-header">${config.theme}</div><div class="batch-dates">å·²é¸æ—¥æœŸï¼š${dates.join(', ')}</div><select onchange="updateBatchChoice('${gid}', this.value)">${optionsHtml}</select><div class="batch-subtotal" id="subtotal-${gid}">å°è¨ˆï¼šNT$ 0</div>`; container.appendChild(card); }); calculateTotal(); }
    function updateBatchChoice(gid, value) { userStallChoices[gid] = value; calculateTotal(); }
    function calculateTotal() { let totalFee = 0; let totalDeposit = 0; let grandTotal = 0; const groups = {}; selectedDates.forEach(dateStr => { const config = appData.settings.dates.find(d => d.date === dateStr); if(config) { const gid = config.groupId || dateStr; if(!groups[gid]) groups[gid] = []; groups[gid].push(dateStr); } }); Object.entries(groups).forEach(([gid, dates]) => { const config = appData.settings.dates.find(d => d.date === dates[0]); const choice = userStallChoices[gid]; let subtotal = 0; let subRent = 0; let subDeposit = 0; if (choice) { const stall = config.stalls.find(s => s.name === choice); if (stall) { if (dates.length >= 2 && stall.price2 && parseInt(stall.price2) > 0) { subRent += parseInt(stall.price2); if(dates.length > 2) subRent += parseInt(stall.price1) * (dates.length - 2); } else { subRent += parseInt(stall.price1) * dates.length; } subDeposit = parseInt(config.deposit || 1000); subtotal = subRent + subDeposit; } } const subEl = document.getElementById(`subtotal-${gid}`); if(subEl) subEl.innerText = `ç§Ÿé‡‘$${subRent} + æŠ¼é‡‘$${subDeposit} = å°è¨ˆ NT$ ${subtotal}`; totalFee += subRent; totalDeposit += subDeposit; grandTotal += subtotal; }); document.getElementById('txtTotal').innerText = `NT$ ${grandTotal}`; return grandTotal; }
    async function submitData() { const form = document.getElementById('regForm'); if (!form.checkValidity()) { form.reportValidity(); return; } if (selectedDates.length === 0) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; } if (!document.getElementById('agree').checked) { alert('è«‹åŒæ„è¦ç¯„'); return; } const groups = new Set(); selectedDates.forEach(dateStr => { const config = appData.settings.dates.find(d => d.date === dateStr); if(config) groups.add(config.groupId || dateStr); }); let allSelected = true; let summaryList = []; groups.forEach(gid => { if(!userStallChoices[gid]) allSelected = false; else { const sampleDate = appData.settings.dates.find(d => (d.groupId || d.date) === gid); summaryList.push(`${sampleDate.theme}: ${userStallChoices[gid]}`); } }); if(!allSelected) { alert('è«‹ç‚ºæ¯ä¸€å€‹é¸å–çš„æª”æœŸé¸æ“‡æ”¤ä½é¡å‹'); return; } const fileInput = document.getElementById('fileInput'); if (fileInput.files.length === 0) { alert('è«‹ä¸Šå‚³ç…§ç‰‡'); return; } document.getElementById('loading').style.display = 'flex'; const filesToUpload = []; for(let i=0; i<fileInput.files.length; i++){ filesToUpload.push(await readFile(fileInput.files[i])); } const payload = { brandName: form.brandName.value, concept: form.concept.value, mainProduct: form.mainProduct.value, contactName: form.contactName.value, contactPhone: form.contactPhone.value, lineId: form.lineId.value, socialLink: form.socialLink.value, selectedDates: selectedDates.join(','), stallSummary: summaryList.join('\n'), finalTotal: document.getElementById('txtTotal').innerText, files: filesToUpload }; fetchData('submit', { payload: payload }); }
    function formatDateShort(dateStr) { const parts = dateStr.split('-'); return `${parts[1]}/${parts[2]}`; }
    function toggleDesc(id, btn) { const el = document.getElementById(id); if (el.style.display === 'block') { el.style.display = 'none'; btn.innerText = 'ğŸ“„ æŸ¥çœ‹æ´»å‹•è©³æƒ… â–¼'; } else { el.style.display = 'block'; btn.innerText = 'ğŸ“„ æ”¶èµ·èªªæ˜ â–²'; } }
    function readFile(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = e => resolve({ name: file.name, mimeType: file.type, data: e.target.result.split(',')[1] }); reader.onerror = reject; reader.readAsDataURL(file); }); }
    function saveGlobalDescription() { const val = document.getElementById('globalDescInput').value; appData.settings.globalDescription = val; fetchData('saveConfig', { settings: appData.settings }); }
    function updateCharCount(el) { document.getElementById('charCount').innerText = el.value.length; }
    function downloadExcel() { if(!confirm('å»ºç«‹ Excel åŒ¯å‡ºæª”ï¼Ÿ')) return; window.open(`${API_URL}?action=excel`, '_blank'); }
    function downloadBlacklist() { if(!confirm('å»ºç«‹é•è¦åå–® Excelï¼Ÿ')) return; window.open(`${API_URL}?action=blacklist`, '_blank'); }
    function adminLoginPrompt() { const pwd = prompt("è«‹è¼¸å…¥å¯†ç¢¼"); if (pwd) { document.getElementById('loading').style.display = 'flex'; fetchData('verifyLogin', pwd); } }
    function handleLogin(res) { document.getElementById('loading').style.display = 'none'; if (res.success) { document.getElementById('appView').classList.add('hidden'); document.getElementById('adminView').classList.remove('hidden'); if (res.role === 'guest') { isReadOnly = true; document.getElementById('adminView').classList.add('read-only-mode'); document.getElementById('guestNotice').style.display = 'block'; document.querySelector('#tab-settings > div:first-child').style.display = 'none'; } else { isReadOnly = false; document.getElementById('adminView').classList.remove('read-only-mode'); document.getElementById('guestNotice').style.display = 'none'; document.getElementById('passwordManager').style.display = 'block'; } switchTab('schedule'); } else { alert("å¯†ç¢¼éŒ¯èª¤"); } }
    function changePass(type) { const inputId = type === 'admin' ? 'adminPassInput' : 'guestPassInput'; const val = document.getElementById(inputId).value; if (!val) return alert('è«‹è¼¸å…¥æ–°å¯†ç¢¼'); if (!confirm('ç¢ºå®šè¦ä¿®æ”¹å¯†ç¢¼å—ï¼Ÿ')) return; fetchData('updatePassword', { type: type, newPass: val }); }
    function switchTab(tab) { ['schedule', 'list', 'settings', 'finance', 'blacklist'].forEach(t => { const el = document.getElementById(`tab-${t}`); const btn = document.getElementById(`btn-${t}`); if(el) el.classList.add('hidden'); if(btn) btn.classList.remove('active'); }); document.getElementById(`tab-${tab}`).classList.remove('hidden'); document.getElementById(`btn-${tab}`).classList.add('active'); if(tab === 'schedule') renderSchedule(); if(tab === 'list') renderList(); if(tab === 'settings') renderSettingsList(); if(tab === 'finance') renderFinance(); if(tab === 'blacklist') renderBlacklist(); }
    function renderSchedule() { const container = document.getElementById('scheduleContainer'); container.innerHTML = ''; const dates = (appData.settings.dates || []).sort((a,b) => new Date(a.date) - new Date(b.date)); dates.forEach(d => { const dayDiv = document.createElement('div'); dayDiv.className = 'schedule-day'; dayDiv.innerHTML = `<div class="schedule-header"><span>${d.date} (${d.theme}) <small>${d.start}~${d.end}</small></span></div>`; const body = document.createElement('div'); body.className = 'schedule-body'; d.stalls.forEach(stall => { const groupDiv = document.createElement('div'); groupDiv.className = 'stall-group'; const bookedBrands = appData.registrations.filter(r => { const regDates = String(r.dates); const dateMatch = regDates.indexOf(d.date) > -1; const stallNameMatch = (r.stallSummary || "").indexOf(stall.name) > -1; return dateMatch && stallNameMatch && r.status !== 'å–æ¶ˆ' && r.status !== 'é•åè¦å®š'; }).sort((a,b) => a.timestamp.localeCompare(b.timestamp)); const limit = parseInt(stall.qty || 0); const count = bookedBrands.length; groupDiv.innerHTML = `<div class="stall-title">${stall.name} <span style="background:#eee;padding:2px 8px;border-radius:10px;font-size:0.8em;${count>=limit?'background:#e74c3c;color:white':''}">${count} / ${limit}</span></div>`; bookedBrands.forEach((r, idx) => { const item = document.createElement('div'); item.className = `stall-item ${ (idx + 1) > limit ? 'overbooked' : ''}`; const isPaid = r.paymentStatus === 'å·²ç¹³æ¬¾'; const payClass = isPaid ? 'bg-paid' : 'bg-unpaid'; const payText = isPaid ? 'ğŸ’° å·²ç¹³' : 'âš ï¸ æœªç¹³'; let statusClass = 'bg-wait'; if (r.status === 'å·²ç¢ºèª') statusClass = 'bg-ok'; else if (r.status === 'å–æ¶ˆ') statusClass = 'bg-cancel'; else if (r.status === 'é•åè¦å®š') statusClass = 'bg-violation'; item.innerHTML = `<div class="item-header"><span>${idx+1}. ${r.brandName}</span></div><div class="item-badges"><span class="badge ${payClass}">${payText}</span><span class="badge ${statusClass}">${r.status}</span></div>`; groupDiv.appendChild(item); }); body.appendChild(groupDiv); }); dayDiv.appendChild(body); container.appendChild(dayDiv); }); }
    function renderList() { const tbody = document.getElementById('regTableBody'); tbody.innerHTML = ''; appData.registrations.forEach(r => { const tr = document.createElement('tr'); const paySelect = createStatusSelect(r.id, 'paymentStatus', r.paymentStatus, ['æœªç¹³æ¬¾', 'å·²ç¹³æ¬¾'], ['st-unpaid', 'st-paid']); const statusSelect = createStatusSelect(r.id, 'status', r.status, ['æœªé€šçŸ¥', 'å·²ç¢ºèª', 'å€™è£œ', 'å–æ¶ˆ', 'é•åè¦å®š'], ['st-wait', 'st-ok', 'st-wait', 'st-cancel', 'st-violation']); const datesDisplay = formatDatesForDisplay(r.dates); tr.innerHTML = `<td><small>${r.timestamp}</small></td><td><b>${r.brandName}</b><br><small>${r.product}</small></td><td><div style="color:#007bff;font-weight:bold;font-size:0.9em;margin-bottom:3px;">${datesDisplay}</div><small style="color:#666;">${r.stallSummary ? r.stallSummary.replace(/\n/g,'<br>') : r.stallType}</small></td><td>${r.total}</td><td><a href="${r.folderUrl}" target="_blank" class="btn-sm" style="background:var(--primary)">æŸ¥çœ‹</a></td><td></td><td></td><td><button onclick="delReg('${r.id}')" class="btn-sm" style="background:#e74c3c">åˆª</button></td>`; tr.children[5].appendChild(paySelect); tr.children[6].appendChild(statusSelect); tbody.appendChild(tr); }); }
    function renderBlacklist() { const tbody = document.getElementById('blacklistBody'); tbody.innerHTML = ''; const violations = appData.registrations.filter(r => r.status === 'é•åè¦å®š'); if (violations.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#888;">ç›®å‰ç„¡é•è¦ç´€éŒ„</td></tr>'; return; } violations.forEach(r => { const tr = document.createElement('tr'); const datesDisplay = formatDatesForDisplay(r.dates); tr.innerHTML = `<td><small>${r.timestamp}</small></td><td style="color:#dc3545; font-weight:bold;">${r.brandName}</td><td>${r.contact}</td><td>${r.contactPhone}<br>${r.line}</td><td><span style="color:#dc3545;font-weight:bold;font-size:0.9em;">[${datesDisplay}]</span><br><small>${r.stallSummary ? r.stallSummary.replace(/\n/g, ', ') : '-'}</small></td><td><div style="display:flex; gap:5px; align-items:center;"><select onchange="updateNoteReason('${r.id}', this.value)" style="width:auto; padding:2px;"><option value="">å¿«é€Ÿæ¨™è¨˜ â–¼</option><option value="å¤±è¯">å¤±è¯</option><option value="é€¾æ™‚ç¹³è²»">é€¾æ™‚ç¹³è²»</option><option value="other">å…¶ä»–(æ‰‹å‹•)</option></select><input type="text" id="note-${r.id}" value="${r.note}" onblur="saveNoteManual('${r.id}', this.value)" style="width:120px; font-size:0.9em;"></div></td>`; tbody.appendChild(tr); }); }
    function updateNoteReason(id, val) { if(!val) return; const input = document.getElementById(`note-${id}`); if(val === 'other') { input.focus(); return; } input.value = val; saveNoteManual(id, val); }
    function saveNoteManual(id, val) { const target = appData.registrations.find(r => r.id === id); if(target) target.note = val; fetchData('updateStatus', { id: id, type: 'note', value: val }); }
    
    // â˜…â˜…â˜… ä¿®æ­£å¾Œçš„æ—¥æœŸé¡¯ç¤ºå‡½æ•¸ (å»é™¤è‹±æ–‡å­—æ¯äº‚ç¢¼) â˜…â˜…â˜…
    function formatDatesForDisplay(dateString) { 
        if (!dateString) return ''; 
        return dateString.split(',').map(d => { 
            let cleanDate = d.split('T')[0]; // å¼·åˆ¶å»é™¤ T å¾Œé¢çš„æ™‚é–“
            const parts = cleanDate.split('-'); 
            if(parts.length < 3) return cleanDate;
            return `${parts[1]}/${parts[2]}`; 
        }).join(', '); 
    }
    
    function createStatusSelect(id, type, currentVal, options, classes) { const sel = document.createElement('select'); sel.className = 'status-select'; options.forEach((opt, idx) => { const option = document.createElement('option'); option.value = opt; option.text = opt; if(opt === currentVal) { option.selected = true; sel.classList.add(classes[idx]); } sel.appendChild(option); }); sel.onchange = function() { sel.className = 'status-select ' + classes[sel.selectedIndex]; const target = appData.registrations.find(r => r.id === id); if(target) target[type] = this.value; fetchData('updateStatus', { id: id, type: type, value: this.value }); }; return sel; }
    function delReg(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { fetchData('updateStatus', { id: id, type: 'delete' }).then(() => { appData.registrations = appData.registrations.filter(r=>r.id!=id); renderList(); }); } }
    function addStallInputRow(name='', p1='', p2='', qty='') { const div = document.createElement('div'); div.className = 'stall-input-row'; div.innerHTML = `<input type="text" class="s-name" placeholder="åç¨±" value="${name}" style="flex:3"><input type="number" class="s-p1" placeholder="$å–®æ—¥" value="${p1}" style="flex:1"><input type="number" class="s-p2" placeholder="$é›™æ—¥" value="${p2}" style="flex:1"><input type="number" class="s-qty" placeholder="åé¡" value="${qty}" style="flex:1; background:#fff8e1;"><button class="btn-sm" onclick="this.parentElement.remove()" style="background:#ccc;">X</button>`; document.getElementById('newStallContainer').appendChild(div); }
    function editDateConfig(gid) { editingGroupId = gid; const groupDates = appData.settings.dates.filter(d => d.groupId === gid).sort((a,b)=>new Date(a.date)-new Date(b.date)); if(groupDates.length === 0) return; const first = groupDates[0]; const last = groupDates[groupDates.length-1]; document.getElementById('newStartDate').value = first.date; document.getElementById('newEndDate').value = last.date; document.getElementById('newThemeVal').value = first.theme; document.getElementById('newGroupDesc').value = first.description || ''; document.getElementById('newStartTime').value = first.start; document.getElementById('newEndTime').value = first.end; document.getElementById('newDepositVal').value = first.deposit; const stallContainer = document.getElementById('newStallContainer'); stallContainer.innerHTML = ''; first.stalls.forEach(s => { addStallInputRow(s.name, s.price1, s.price2, s.qty); }); document.getElementById('settingFormTitle').innerText = 'ç·¨è¼¯æª”æœŸå€å¡Š'; document.getElementById('saveDateBtn').innerText = 'å„²å­˜æ›´æ–°'; document.getElementById('saveDateBtn').style.background = '#007bff'; document.getElementById('cancelEditBtn').style.display = 'inline-block'; document.getElementById('tab-settings').scrollIntoView(); }
    function resetSettingForm() { editingGroupId = null; document.getElementById('newStartDate').value = ''; document.getElementById('newEndDate').value = ''; document.getElementById('newThemeVal').value = ''; document.getElementById('newGroupDesc').value = ''; document.getElementById('newStallContainer').innerHTML = ''; addStallInputRow("å¸³ç¯·æ”¤ä½ (3x3m)", 800, 1500, 6); addStallInputRow("ç„¡å‚˜æ¡Œæ”¤ä½", 600, 1000, 11); document.getElementById('settingFormTitle').innerText = 'æ–°å¢/ç·¨è¼¯æª”æœŸå€å¡Š'; document.getElementById('saveDateBtn').innerText = 'å»ºç«‹æ–°æª”æœŸ'; document.getElementById('saveDateBtn').style.background = 'var(--accent)'; document.getElementById('cancelEditBtn').style.display = 'none'; }
    function saveDateConfig() { const startDate = document.getElementById('newStartDate').value; const endDate = document.getElementById('newEndDate').value; const theme = document.getElementById('newThemeVal').value; const desc = document.getElementById('newGroupDesc').value; const start = document.getElementById('newStartTime').value; const end = document.getElementById('newEndTime').value; const deposit = document.getElementById('newDepositVal').value; if(!startDate || !endDate || !theme) return alert('è«‹å¡«å¯«å®Œæ•´æ—¥æœŸå€é–“èˆ‡ä¸»é¡Œ'); const stalls = []; document.querySelectorAll('.stall-input-row').forEach(row => { const name = row.querySelector('.s-name').value; const p1 = row.querySelector('.s-p1').value; const p2 = row.querySelector('.s-p2').value; const qty = row.querySelector('.s-qty').value; if(name && p1) stalls.push({ name, price1: p1, price2: p2, qty: qty || 999 }); }); if(stalls.length === 0) return alert('è«‹è¨­å®šè‡³å°‘ä¸€å€‹æ”¤ä½'); const newGroupId = editingGroupId || ('G-' + Date.now()); if(editingGroupId) { appData.settings.dates = appData.settings.dates.filter(d => d.groupId !== editingGroupId); } const s = new Date(startDate); const e = new Date(endDate); for (let d = s; d <= e; d.setDate(d.getDate() + 1)) { const dateStr = d.toISOString().split('T')[0]; appData.settings.dates.push({ date: dateStr, theme, description: desc, start, end, deposit, stalls, open: true, full: false, groupId: newGroupId }); } fetchData('saveConfig', { settings: appData.settings }); }
    function renderSettingsList() { const list = document.getElementById('adminDateList'); list.innerHTML = ''; const groups = {}; appData.settings.dates.forEach(d => { const gid = d.groupId || ('LEGACY-'+d.date); if(!groups[gid]) groups[gid] = []; groups[gid].push(d); }); const sortedGroupIds = Object.keys(groups).sort((a,b) => new Date(groups[a][0].date) - new Date(groups[b][0].date)); sortedGroupIds.forEach(gid => { const groupItems = groups[gid]; const first = groupItems[0]; const last = groupItems[groupItems.length-1]; const isOpen = first.open !== false; const dateRange = (groupItems.length > 1) ? `${first.date} ~ ${last.date}` : first.date; const div = document.createElement('div'); div.style.padding = "10px"; div.style.borderBottom = "1px solid #eee"; div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><strong>${dateRange} ${first.theme}</strong><div><button class="btn-sm" style="background:#007bff; margin-right:5px;" onclick="editDateConfig('${gid}')">ç·¨è¼¯</button><span style="font-size:0.8em; padding:2px 6px; border-radius:4px; background:${isOpen?'#d4edda':'#f8d7da'}">${isOpen?'å ±åä¸­':'å·²é—œé–‰'}</span></div></div><small style="color:#666;">æŠ¼é‡‘: $${first.deposit} | æ”¤ä½: ${first.stalls.map(s=>s.name).join(',')}</small><div style="margin-top:5px;"><button class="btn-sm" onclick="toggleGroup('${gid}')">${isOpen?'é—œé–‰æ•´æª”':'é–‹å•Ÿæ•´æª”'}</button><button class="btn-sm" style="background:red; float:right;" onclick="removeGroup('${gid}')">åˆªé™¤æ•´æª”</button></div>`; list.appendChild(div); }); }
    function toggleGroup(gid) { const targetState = !(appData.settings.dates.find(d => d.groupId === gid).open !== false); appData.settings.dates.forEach(d => { if(d.groupId === gid) d.open = targetState; }); fetchData('saveConfig', { settings: appData.settings }); }
    function removeGroup(gid) { if(confirm('ç¢ºå®šåˆªé™¤æ­¤æª”æœŸå€å¡Šï¼Ÿ')) { appData.settings.dates = appData.settings.dates.filter(d => d.groupId !== gid); fetchData('saveConfig', { settings: appData.settings }); } }
  </script>
</body>
</html>